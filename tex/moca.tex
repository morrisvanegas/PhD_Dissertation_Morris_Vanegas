% moca.tex:

\chapter{MODULAR OPTODE CONFIGURATION ANALYZER (MOCA)} % all caps please
\label{chap:moca}
This is part 1 of 2 of the work addressing the second challenge described in Chapter~\ref{chap:introduction}. This chapter will focus on \ac{MOCA}, a software workflow created with the intention of simplifying the design of new modular \ac{fNIRS} systems. Chapter~\ref{chap:mobi} will describe the \ac{fNIRS} system built to translate neuroimaging into natural settings. 

%%% Section %%% 
\section{Introduction}
\label{sec:introduction}
\ac{fNIRS} is an emerging neuroimaging technique to non-invasively measure brain activity using non-ionizing light~\cite{Ferrari2012}. Unlike \ac{fMRI}~\cite{Heinzel2013} that requires high-strength magnetic fields and large scanners, \ac{fNIRS} utilizes \ac{NIR} light to detect brain activation by measuring the associated hemodynamics. The portability of \ac{fNIRS} positions it as a competitive imaging modality to address some of the challenges of conventional neuroimaging techniques, such as \ac{fMRI} and \ac{MEG}, including a lack of wearability for continuous monitoring, limited temporal resolution, and need for subject immobility during use~\cite{Yucel2017}. It has shown great promise for safe and long-term monitoring of brain activity and is increasingly used in studies for behavioral~\cite{McDonald2018} and cognitive neurodevelopment~\cite{Aslin2015, Vanderwert2014, Wilcox2015, Soltanlou2018}, language~\cite{Quaresima2012, Rossi2012}, psychiatric conditions~\cite{Ehlis2014, Kumar2017}, stroke recovery~\cite{Yang2019}, and brain-computer interfaces~\cite{Naseer2015, Ahn2017, Hong2018}. 

Despite exponential growth in the number of applications~\cite{Boas2014, Quaresima2019} and publications~\cite{Yucel2017} in recent years, many \ac{fNIRS} systems still employ fiber-based, cart-sized instrumentation~\cite{Scholkmann2014} that place limits on both channel density and the use of \ac{fNIRS} in natural environments. Although fiber-based high-density~\cite{Eggebrecht2014} and portable~\cite{Wheelock2019} \ac{fNIRS} systems have been demonstrated, the use of fragile fiber optics cables, stationary external source/detector units~\cite{Oxymon2017, Techen2018}, and the need for individual and specialized headgear for specific tasks have motivated the \ac{fNIRS} community to investigate more flexible modular and fiber-less designs~\cite{Zhao2017, Curtin2018}.

The modular \ac{fNIRS} architecture is based on utilizing elementary optical source and detector circuits (modules) as repeating building blocks to form a re-configurable probe~\cite{Zhao2017}. This modular architecture offers significantly improved portability, scalability, flexibility in coverage, and fabrication cost~\cite{Zhao2017}. By avoiding the use of fragile optical fibers, modular \ac{fNIRS} systems permit the use of light guides to directly couple light sources and detectors to the scalp, significantly reducing signal loss due to fiber coupling. The lightweight and compact modules also make wearable \ac{fNIRS} and continuous monitoring in mobile environments possible~\cite{Yucel2017, Park2018}. In addition, the ability to use both intra-module (within a single module) and inter-module (source and detector on different modules) channels allows for high-density probes with varying \ac{SDS}s that increase measurement density and tissue depth sampling, resulting in enhanced signal quality, and easy removal of physiological noise~\cite{Gregg2010}. 

Despite these perceived benefits, the task of designing a modular \ac{fNIRS} probe can quickly grow in complexity as the number of modules increases. While parameters can be empirically determined when designing a single module, understanding the trade-offs among a large array of parameters, including module shape, module size, optode quantities, and optode locations, and each parameter's effects on the final probe can become a daunting task. Not only do most published modular \ac{fNIRS} studies largely focus on the design of a single module without addressing the effect of these module- and probe-level parameters on the final probe, but the current literature also does not provide a means to compare probes composed of different module designs.

Aside from the challenges of determining these modular probe core parameters, other factors such as mechanical, ergonomic, safety, usability, optoelectronic, and data communication considerations~\cite{Zhao2017} also play important roles in achieving the desired performance. For example, mechanical features such as optical coupling and electronic circuitry encapsulation must be considered alongside ergonomic considerations such as comfort, weight, and robustness. Additionally, the use of high-density light sources in such modular probes brings about additional safety considerations, such as heat dissipation, driving voltage, and battery life. Moreover, optoelectronic considerations arise from the use of specialized optodes with narrow emission bandwidths, high gains, low noise, and \ac{fNIRS}-optimized wavelengths. Not only are these specialized optodes more expensive due to their niche applications and characteristics, but they also require more complex control electronics for driving optodes and acquiring data. With such dense coverage, complex encoding strategies such as frequency~\cite{Maki1995} multiplexing become a necessity for obtaining high-density data acquisition to achieve sufficient spatial and temporal resolution. Finally, while previously reported modular \ac{fNIRS} systems often employ daisy-chain communication protocols to connect multiple modules on a single bus~\cite{Chitnis2016, Bci2017, Zimmermann2013, Funane2017, Zhao2019}, the design of physical inter-module connections~\cite{Zhao2021}, the synchronization method between modules~\cite{Zhao2017}, and the transfer of acquired data become increasingly complex with high module counts and branching connections.

Along these lines, a number of \ac{fNIRS} data analysis packages exists~\cite{Huppert2009, Santosa2018, Hernandez2020}. However, they focus on the statistical analysis of the data ~\cite{Hernandez2020,Huppert2009, Santosa2018} to enhance its quality and provide guidance on post-processing steps such as motion artifact correction~\cite{Huppert2009}. While some other tools exist to assist in the probe design~\cite{Brigadoi2018, Machado2018, ZimeoMorais2018, Aasted2015}, most of these tools are designed to work in a highly constrained design space, where the probe parameters are mostly pre-determined by the user. As a result, the best practices and trade-offs in modular probe design such as tessellation, connection, or re-orientation are poorly explored and understood. Therefore, the community is in great need of an easy-to-use software tool to assist the exploration of and quantitative comparisons among countless parameter choices in a modular probe design and to perform a limited degree of optimization within a well-constrained configuration. 

A fully-automated probe design and optimization pipeline is impractical without application-dependent design constraints. Instead, we report a simplified, easy-to-use software toolbox to help designers navigate the vast parameter space of a modular probe. We also share a number of fundamental modular probe design strategies, discovered through our explorations via this toolbox, that are not widely recognized or previously studied. The entire workflow has been implemented into an open-source, MATLAB-based toolbox called Modular Optode Configuration Analyzer (MOCA~\cite{Vanegas2020}). \ac{MOCA} supports a list of commonly used module shapes, user-defined optode layouts, and \ac{ROI} coverage, and can produce quantitative performance metrics such as distributions of \ac{SD} separations, sensitivity maps, and spatial multiplexing groupings. These performance metrics also allow comparisons between different designs of modular probes. Although \ac{MOCA} is not designed as a fully-automated software that produces ``optimal'' probes regardless of application, its unique capability to describe and sweep modular probe parameters in operator-guided interrogations offers valuable perspective to start approaching the complex modular hardware design problem and make informed comparisons between well-constrained design choices.

The remainder of the paper is outlined below. In Section~\ref{sec:overview}, we discuss the relevant design considerations when developing a modular probe using \ac{MOCA}. We specifically focus on the parameterization of the modules, processes required to assemble modules into functional probes, and related performance metrics for system characterization and comparisons. In Section~\ref{sec:results}, we demonstrate \ac{MOCA}'s capability in designing full-head probes using a variety of module shapes and compare their trade-offs regarding channel density, \ac{SD} separations, and average brain sensitivities. Furthermore, we utilize \ac{MOCA} to showcase potential improvements to published \ac{fNIRS} probes by altering module orientations, spacing, and staggering layouts. In Section~\ref{sec:discussion}, we highlight a number of generalizable design strategies that were discovered via our experiments using \ac{MOCA}, including the importance of considering module orientations, tiling strategies, and module spacing tuning, among others.



%%% Section %%%
% OVERVIEW
\section{Modular Probe Parameters and Performance Metrics}
\label{sec:overview}

\begin{figure}
    \begin{center}
    \begin{tabular}{c}
    \includegraphics[height=10cm]{fig/moca/Fig_1.pdf}
    \end{tabular}
    \end{center}
    \caption { \label{fig:flowchart} Workflow of module-level design parameters (left column; blue) used in probe-level processes (center column; red) to produce performance metrics to characterize a probe (right column; green). Performance metrics are organized top to bottom from least complex (two parameters needed) to most complex (four parameters needed). Arrows trace how parameters are used to derive specific performance metrics.} 
\end{figure} 

A diagram showing the overall design process of a modular \ac{fNIRS} system is shown in Fig.~\ref{fig:flowchart}. Specifically, the three parts describing \ac{MOCA}'s workflow are 1) the design parameters describing a single module design, 2) the processes and parameters used to assemble the modules into a probe, and 3) the derived performance metrics used to characterize the resulting probe. \ac{MOCA} starts with the definition of essential module parameters (shown in the left column in Fig.~\ref{fig:flowchart}), applies those parameters along with probe-level constraints to a probe-generation process (center column in Fig.~\ref{fig:flowchart}), and derives quantitative performance metrics of the resulting probe (shown in the right column in Fig.~\ref{fig:flowchart}). Arrows in Fig.~\ref{fig:flowchart} define dependencies between the derived performance metrics and the input parameters. For example, in order to calculate the probe's channel distribution, one must define the module geometry, \ac{ROI}, and optode layout design parameters. 

%%% Subsection %%%
\subsection{Essential module-level design parameters of fNIRS modular probes}
The basic building block of a modular probe is an \ac{fNIRS} module. It is typically in the form of an optoeletronic circuit made of a rigid~\cite{Chitnis2016, Bci2017, Zhao2019, Wyser2017} or rigid-flex~\cite{Muehlemann2008, Hallacoglu2016} substrate with on-board light sources, optical sensors, auxiliary sensors, microcontrollers, and other communication electronics. A modular probe is subsequently constructed by replicating and interconnecting multiple identical modules. Therefore, the design decisions regarding the module-level parameters are highly important and directly impact the functionalities and restrictions of the resulting probe.

\subsubsection{Single module geometry}
The shape of a module is one of the key parameters when designing a modular system. In the published literature, simple polyhedral shapes, especially equilateral polygons (square, hexagon, etc), are typically used due to their simplicity to fabricate, analyze, and tessellate over a target \ac{ROI}. It is also possible to design probes that combine multiple polygonal shapes, such as a combination of hexagonal and pentagonal modules. Such hybrid-shape modular systems may bring advantages in tessellating curved surfaces, but they also require more complex analyses. \ac{MOCA} supports a number of built-in module shapes including three equilateral polygons (triangle, square, hexagon). In such cases, the module edge length is the only shape parameter that needs to be defined. One should be aware that a small-sized module requires a large number of boards to cover a given area, thus resulting in higher fabrication costs and higher complexity in assembly and analysis. Moreover, a small module size also limits the maximum intra-module \ac{SDS}. Shorter \ac{SD} separations are known to be more sensitive to superficial tissues rather than brain activities. On the other hand, a small-module size provides better probe-to-scalp coupling when a rigid-board-based module is used. \ac{MOCA} provides support for user-specified arbitrary polygonal modules, defined by a sequence of two-dimensional (2-D) coordinates. Subsequent analyses of these user-defined arbitrary module shapes only use the bounding box of these polygons when varying probe-level parameters.

\subsubsection{Target regions-of-interest}
An \ac{ROI} refers to the area of the scalp directly above the cortex for which brain activities are expected to occur\cite{Hiroyasu2015}. For simplicity, here we focus on designing probes based on the coverage of a 2-D \ac{ROI}. For generality, \ac{MOCA} specifies an \ac{ROI} geometry as a closed polygon made of a sequence of 2-D coordinates. Users need to specify at least three Cartesian coordinates to define a closed \ac{ROI}. In the future, \ac{MOCA} can potentially be expanded to support three-dimensional (3-D) surfaces as \ac{ROI}s through the use of 3-D surface tessellation tools, such as the Iso2Mesh~\cite{Fang2009a} mesh generator and 3-D photon transport modeling tools such as NIRFAST~\cite{Nirfast} and Monte Carlo eXtreme~\cite{Fang2009} (MCX).

\subsubsection{Optode layout within a single module}
Optode layout refers to the spatial arrangement of optical sources and light sensors within the boundaries of a single polygonal module. In \ac{MOCA}, each source and detector position is defined by a set of discrete 2-D coordinates relative to the module's center. The 2-D coordinates define the center of the active area of the light-emitting-diode (LED), laser, or photodetector. The physical dimensions of the optodes as well as the size and location of electronic components needed to drive each optode are not considered. The \ac{SD} separations between all combinations of \ac{SD} pairs are derived based on the optode positions.

\subsubsection{Maximum source-detector separation and maximum short separation channel}
\ac{MOCA} also considers the maximum \ac{SD} separation ($SDS_{max}$) as a key design parameter. Typically, $SDS_{max}$ is determined by the signal-to-noise ratio (SNR) of the detected signal~\cite{Arnulphi2009}. A large \ac{SDS} has low detector sensitivity due to the exponential decay of light intensity as \ac{SDS} increases. This maximum separation limits the number of inter-module channels that emerge from a particular tessellation of modules over an \ac{ROI}. By default, \ac{MOCA} considers any \ac{SDS} below 10~mm to be a short-separation (SS) channel. This threshold can be manually changed to fit any specific optode performance or probe application. \ac{MOCA} uses 30~mm as the default $SDS_{max}$~\cite{Taga2007, LloydFox2010}. \ac{MOCA} bounds the \ac{SD} range by the SS channel threshold and the $SDS_{max}$. 

%%% Subsection %%%
\subsection{Probe-level assembly process parameters}
A modular probe is constructed when multiple modules are arranged to form a non-overlapping coverage of the \ac{ROI} area. The final probe is dependent on the tessellation (the number of modules and the spacing between them) and the orientation of each individual module in the probe.

\subsubsection{Exploring module tessellation and probe spacing}
\ac{MOCA} provides a process to tessellate modules over a user-defined 2-D polygonal \ac{ROI}, which is generally known as the ``tiling'' problem in computational geometry~\cite{Winslow2015}. Here, a ``complete tessellation'' refers to the tiling of an \ac{ROI} using a single module shape without overlapping or leaving a gap in coverage. Each of the three built-in polygons (triangle, square, hexagon) have the ability to cover a 2-D area~\cite{Samet1990}. \ac{MOCA} performs the tessellation by first tiling the module shape along a horizontal axis starting at the lowest vertical coordinate of the \ac{ROI} until the width of the row composed of adjacent modules is wider than the width of the corresponding segment of \ac{ROI} the row is tiled over. It then repeats this row-generation process until the height of all the rows combined is larger than the maximum height of the defined \ac{ROI}. This dimension comparison in both axes accounts for module shapes with non-vertical and non-horizontal sides. For irregular module shapes, \ac{MOCA} uses the maximum width and maximum height of the defined polygon as the bounding box to create a tiling grid of the module over the \ac{ROI}. Using the maximum width and height of the \ac{ROI} as a guide for tiling ensures the full \ac{ROI} is covered. Although \ac{MOCA} offsets and flips the three equilateral polygon shapes to prevent gaps, irregular module shapes have inherent gaps between modules when tessellated. Additionally, \ac{MOCA} accepts manually defined tessellations by reading a sequence of coordinates defining the center of modules to specify each individual module's location within the \ac{ROI}. Following tessellation, each module is assigned a unique index and an adjacency matrix is constructed to represent which modules are next to one another.

To extend the flexibility of probe creation, users can change probe spacing, the minimum distance between adjacent modules in all directions. Additionally, a module can be manually deleted from the tessellation to allow the probe to more closely follow the boundaries of the \ac{ROI} or better represent intentional empty spaces in the probe. When individual modules are removed from the probe, the adjacency matrix is re-calculated from the resulting probe. 

\subsubsection{Guiding module orientation and connection routing}
Module orientation refers to the rotation of the module along the normal direction of the \ac{ROI} plane. In a ``complete tessellation'' of the three equilateral polygon shapes, \ac{MOCA} appropriately flips and translates modules to prevent gaps and overlaps. For tessellations of irregular shapes, each module is simply placed in the same orientation as it was originally defined. After probe generation, \ac{MOCA} allows the user to manually change the orientation of individual modules based on their assigned indices. For asymmetric optode layouts, changing the module orientation alters the \ac{SDS} of inter-module channels, resulting in different performance metrics.

Additionally, \ac{MOCA} creates a single sequential path to connect all modules to form a linear data communication bus, referred to as the ``routing'' process. In such a path, all modules are connected and every module is visited exactly once\textemdash a classic problem known as the Hamilton path~\cite{Kamae1967} in graph theory. In most configurations, a Hamilton path is not unique, and computing such a path is known to be an NP-hard problem, i.e. problems that do not have a polynomial complexity when the node number grows. However, due to the limited module numbers commonly used in \ac{fNIRS} probes, an exhaustive search of the adjacency matrix can typically identify all Hamilton paths in a given tessellation with no more than a few minutes of computation. For any computed path, \ac{MOCA} then orients each module based on the angle of a vector defined by the center of the oriented module and the center of the following module in the path. The orientation angle is relative to the horizontal axis.

%%% Subsection %%%
\subsection{Performance metrics to characterize probes}
Each metric described below changes as module- and probe-level parameters are altered either manually or through \ac{MOCA}'s sweeping functions. \ac{MOCA} not only helps unravel the complex interplay between choices of different parameters but also guides the probe designer in making trade-offs between conflicting design targets\textemdash improving one metric may come at the risk of worsening another. We have chosen the following set of essential performance metrics due to their ability to easily inform a breadth of end-user probe requirements such as cost, weight, depth sensitivity, and sampling rate estimates.

\subsubsection{Total module and optode counts}
Based on the module design and tessellation, \ac{MOCA} computes the total number of modules, $n_m$, needed to cover the \ac{ROI}. In addition, \ac{MOCA} also outputs the total number of sources ($n_s$) and detectors ($n_d$) of the final probe. All modules, sources, and detectors of an assembled probe are given unique identifiable index numbers ($m_i$, $s_i$, and $d_i$, respectively). Module and optode counts are performance metrics outputted by \ac{MOCA} from which cost, weight, and power estimates can be deduced.

\subsubsection{Inter- and intra-module channel distribution}
For any assembled probe, \ac{MOCA} generates histograms of the \ac{SD} separations for all combinations of \ac{SD} pairs. Particularly, it outputs separately the distribution of inter- and intra-module channels that are below the $SDS_{max}$ previously defined by the user. These channel distributions aid the user in designing the probe based on the targeted application and population. For example, shorter channels are more applicable to infant populations. Additionally, \ac{MOCA} outputs channel density, a metric commonly used for \ac{fNIRS} probe benchmarking. Channel density is defined as the number of channels, $n_{channels}$, divided by the area of the \ac{ROI}~\cite{Zhao2017}. Furthermore, \ac{MOCA} can provide a spatial plot overlaying channels on the assembled probe, allowing for visual inspection of low channel density areas within the probe. 

\subsubsection{Spatial brain sensitivity}
\label{sssec:averagebrainsensitivity}
Brain sensitivity ($S_{brain}$) refers to the magnitude of the measurement signal change at a detector given a localized perturbation of optical properties of brain tissue~\cite{Strangman2013}. A higher $S_{brain}$ value suggests the probe is more sensitive to the anticipated brain activation. It is calculated from the spatial probability distribution of photons scattering through complex tissue as they travel from the source to the detector~\cite{Brigadoi2015}. Although modeling 3-D head/brain anatomies and 3-D based light simulations have been reported, including several related works from our group~\cite{Fang2009,Fang2009a,Fang2010,Brain2Mesh2020}, we deliberately chose a simplified layered-slab head model and 2-D based probe layout as default models to evaluate a modular probe in \ac{MOCA}. Such a decision was largely motivated by 1) significantly faster computation and pre-/post-processing to accommodate fast sweeping of a large parameter space, and 2) avoiding another added layer of complexity when probe design is coupled with underlying brain anatomy in a 3-D head model. A comparison between $S_{brain}$ computed by 2-D and atlas-based analyses is provided in the Results section. Nonetheless, \ac{MOCA} can export 2-D probe data to established 3-D probe modeling toolkits, such as AtlasViewer~\cite{Aasted2015} and MCX~\cite{Fang2009}, to perform more advanced analyses when 3-D head models are necessary.

\ac{MOCA} uses a five-layer slab model consisting of tissue imitating the scalp, skull, cerebral spinal fluid (CSF), white matter (WM), and gray matter (GM) to determine the spatial sensitivity profile for each \ac{SD} pair in a probe~\cite{Okada2003}. The thickness of each tissue layer in the slab is set to the average thickness of that tissue type computed using the top half of a tetrahedral brain model~\cite{Sanchez2012}. We define the brain region as the combination of gray matter and white matter tissues. The optical properties and resulting thicknesses for each tissue type are summarized in Table~\ref{tab:opticalproperties}.

\begin{table}
\centering
\caption{Optical properties used in the slab model for calculating brain sensitivity based on Fang~\emph{et al.}~\cite{Fang2010}. The thickness of each layer is derived by dividing the total tissue volume by the tissue's surface area from a tetrahedral five-tissue brain model~\cite{Sanchez2012}. The absorption coefficient, $\mu_{a}$, is the average path a photon will travel in the medium before being absorbed. Similarly, the scattering coefficient, $\mu_{s}$, defines the average path length of photons before a scattering event. Anisotropy, g, is a unit less measure of the amount of forward direction retained after a single scattering event.}
\label{tab:opticalproperties}
\begin{tabular}{@{}lcccc@{}}
\toprule
Tissue Type  & $\mu_{a}$ [$mm^{-1}$] & $\mu_{s}$ [$mm^{-1}$] & g    & Thickness [$mm$] \\ \midrule
Gray Matter                     & 0.020      & 9.000      & 0.89 & 7.25           \\
White Matter                    & 0.080      & 40.900     & 0.84 & 4.00           \\
Cerebral Spinal Fluid           & 0.004      & 0.009      & 0.89 & 2.73           \\
Skull                           & 0.019      & 7.800      & 0.89 & 3.29           \\
Scalp                           & 0.019      & 7.800      & 0.89 & 4.23           \\ \bottomrule
\end{tabular}
\end{table}

For each \ac{SD} pair in the assembled probe, $3\times10^{8}$ photons are simulated using our in-house 3-D Monte Carlo photon transport simulator, MCX~\cite{Fang2009}, using a pencil beam source and a single 1.5~mm radius detector placed at the surface of the slab at its corresponding \ac{SDS}. In a voxelated grid, $S_{brain}$ is defined as a ratio dividing the region-wise summation of the sensitivity matrix in each brain tissue region by the summation of the entire sensitivity matrix for each source-detector separation~\cite{Brigadoi2015}, i.e.
\begin{equation}
\label{eq:fov}
S_{brain}(s,d) = \frac{\sum_{r\in\Omega_{GM}}J(r,s,d) + \sum_{r\in\Omega_{WM}}J(r,s,d)} {\sum_{r\in\Omega}J(r,s,d)},
\end{equation}
where the sensitivity matrix, also known as the Jacobian ($J$), is computed using the adjoint Monte Carlo method~\cite{Yao2018}. In addition to $S_{brain}$, \ac{MOCA} also calculates the average brain sensitivity for the entire probe, $\overline{S_{brain}}$, based on all the \ac{SD} separations above the SS threshold. SS channels are excluded in the calculation of $\overline{S_{brain}}$ because, by definition, they are designed to only sample superficial layers~\cite{Brigadoi2015}.

\subsubsection{Spatial multiplexing groups}
The density of assembled modular probes may impact the probe's temporal sampling rate when illuminating each source sequentially. \ac{MOCA} introduces spatial multiplexing, an encoding strategy that can potentially accelerate data acquisition by simultaneously turning on multiple light sources at the same time. Because of the high attenuation of light in the head and brain tissues at large separations, \ac{MOCA} can ignore the cross-talk of light sources that are far away for a given detector and assign sources into spatial multiplexing groups, or SMG, so that all sources within an SMG can be turned on simultaneously. By default, \ac{MOCA} uses the $SDS_{max}$ as the minimal distance between sources. This distance, however, can be defined by the user. Notably, unlike frequency multiplexing, spatial multiplexing does not require extra energy-intensive hardware or post-measurement separation of combined signals. 

The search for the SMG starts by randomly specifying a source position as the seed; a circle of radius $SDS_{max}$ centered at the seed position is drawn and a random source outside of this circle that is at least 2$\times SDS_{max}$ away is picked; the above process repeats until no additional source can be found. Once an SMG is identified, a new source that does not belong to any existing SMG is selected as the new seed for the next SMG, and the above process repeats until every source is allocated. The total number of spatial multiplexing groups, $n_{SMG}$, depends on the tessellation of the module over the \ac{ROI} as well as the choice of the seed position. As with channels, the $n_{SMG}$ are for a single wavelength. Thus, when estimating the total sampling rate of the probe using dual-wavelength sources, the control unit must cycle through each group twice (once for each wavelength).

In addition to $n_{SMG}$, \ac{MOCA} calculates the spatial multiplexing ratio (SMR), defined as $SMR=n_s/n_{SMG}$. This ratio is interpreted as the acceleration factor of the data acquisition speed when using spatial multiplexing. For example, for a 20-source probe, an $n_{SMG}$ of 5 can accelerate the data acquisition by a factor of $SMR=20/5=4$ fold.



%%% Section %%%
% Additional Features
\section{Additional Functionalities}
\label{sec:features}
\ac{MOCA} was created as an exploratory tool to interrogate specific design parameters and reveal the trade-offs, within a well-constrained search space, regarding specific design decisions. \ac{MOCA} possesses functions to facilitate changing probe-level parameters and exporting the desired probe for use in existing probe design tools such as AtlasViewer.

\subsection{Parameter sweeping}
\subsubsection{Altering spacing between modules}
An optional parameter during module tessellation is probe spacing -- a uniform distance assumed between adjacent modules. The spacing sweep function varies the probe spacing within a user-defined range in user-defined increments. For the three built-in polygons (triangle, square, hexagon), spacing is increased between all adjacent sides of the modules within the probe. For arbitrary shapes, spacing is added to the horizontal and vertical sides of the rectangular bounding box. The number of modules required to cover the \ac{ROI} is continuously adjusted as probe spacing is varied. The performance metrics for each of the resulting probes are reported by \ac{MOCA} as a function of probe spacing.

\subsubsection{Exhaustive search of module orientations}
\ac{MOCA} provides a limited orientation enumeration function to re-orient modules through a predefined number of orientations. For the three built-in polygons, the default number of re-orientations per module is simply the number of sides of the polygon. For arbitrary shapes, the default number of re-orientations is four based on the bounding box. Additionally, a user can describe the number of orientations for any shape. \ac{MOCA} re-orients modules in evenly spaced angle increments. An exhaustive search is performed using the number of modules in the probe and the number of user-defined orientations. Each probe resulting from each permutation of module re-orientations is characterized by \ac{MOCA} and reported as a function of various probe layouts.

\subsubsection{Staggering rows of modules}
Staggering modules refers to shifting a row (or column) of tessellated modules in the $x$ (or $y$) axis. Staggering is performed on tiling grid probe layouts. Adjusting this probe-level parameter is particularly useful for improving probes composed of modules with symmetrical optode layouts, where re-orienting modules does not affect \ac{SDS}, or when high-density probes are needed, where probe spacing cannot be increased. A user defines both the range and increment by which to offset a particular row. Each resulting probe is analyzed and the corresponding performance metrics are calculated. \ac{MOCA} then reports a plot of the $\overline{S_{brain}}$, spatial multiplexing ratio, and the number of channels for each staggered probe.


\subsection{Exporting probe for use in AtlasViewer}
\ac{MOCA} performs its analysis of module- and probe-level parameters on an infinite slab model derived from the Colin27 atlas. When 3-D analysis is desired, \ac{MOCA} can export the probe layout to a ``.sd'' file for use in ``SDgui'' -- a built-in tool of AtlasViewer~\cite{Aasted2015} used for creating and editing ``.sd'' files. To properly represent a modular probe layout in AtlasViewer (which treats all optodes individually without a reference to a module), \ac{MOCA} first translates the module-level parameters by creating fixed/rigid springs between all optode pairs (source-source, source-detector, and detector-detector) within each module. These fixed springs maintain the relative optode layout within each module while permitting bending at the junctions between springs. \ac{MOCA} then adds fixed springs between each inter-module channel (\ac{SD} pairs between modules with distances below the $SDS_{max}$) to translate the probe-level parameters (spacing, orientation, staggering). As an additional constraint, \ac{MOCA} adds flexible springs (springs of length -1) for inter-module channels above the $SDS_{max}$. Finally, to register the probe to the surface of the selected atlas, \ac{MOCA} adds three dummy optodes to the exported ``.sd'' file. All three optodes are placed at the midpoint between the minimum and maximum $x$ coordinates of all optodes in the probe. The $y$ coordinate of the first, second, and third dummy optodes are set to the minimum $y$ coordinate, midpoint, and maximum $y$ coordinate of all optodes in the probe, respectively. The first, second, and third dummy optodes are assigned to the Fpz, Cz, and Oz positions, respectively, in the standard 10-10 system. This places any \ac{MOCA}-designed probe at the top of an atlas by default. A user can change the dummy optode anchors to re-position the probe on an atlas. The exported ``.sd'' file can then be loaded into AtlasViewer for placement on a generic or subject-specific atlas (Fig.~\ref{fig:SDoutput}).


\begin{figure}
\begin{center}
\subfigure[]{\label{fg:SD1}\includegraphics[width=.5\textwidth]{fig/moca/Fig_2a.pdf}}
\subfigure[]{\label{fg:SD2}\includegraphics[width=.4\textwidth]{fig/moca/Fig_2b.pdf}}
\subfigure[]{\label{fg:SD3}\includegraphics[width=.3\textwidth]{fig/moca/Fig_2c.pdf}}
\end{center}
\caption{Example probe exported for use in AtlasViewer~\cite{Aasted2015}. (a) A four-module probe with three sources (red circles) and two detectors (blue crosses) plotted using MOCA. Intra- (blue) and inter-module (orange) channels are shown in solid lines. (b) Imported probe in SDgui. Solid lines represent fixed springs. Dashed green lines represent flexible springs between sources and detectors. Three dummy optodes (numbered 21, 22, and 23) are shown in black. (c) The resulting probe in AtlasViewer registered to an atlas using the dummy optodes as anchors.}
\label{fig:SDoutput}

\end{figure} 



%%% Section %%%
% RESULTS
\section{Results and Practical Examples}
\label{sec:results}
In this section, we first validate the $S_{brain}$ derived from a simplified five-layer slab model against previously published atlas-based $S_{brain}$ results~\cite{Strangman2013}. Then we demonstrate how the module-level parameters of \ac{MOCA} can be used to characterize and compare full-head probes composed of different choices of elementary module designs. Lastly, we show examples using \ac{MOCA}'s assembly processes as investigational tools to potentially improve existing designs by altering probe-level parameters such as probe spacing, module orientations, and the staggering of modules within an assembled probe.

\begin{figure}
    \begin{center}
    \begin{tabular}{c}
    %\includegraphics[height=5.5cm]{mcr3b.eps}
    \includegraphics[width=9cm]{fig/moca/Fig_3.pdf}
    \end{tabular}
    \end{center}
    \caption {Results comparing brain sensitivity derived from finite slab models used by MOCA and atlas-based models. The blue line shows calculated brain sensitivity based on a five-layer slab model for \ac{SD} separations from 0 to 60~mm in 1~mm increments. Overlaid in black are the brain sensitivity results calculated from an atlas by averaging brain sensitivity for fixed source-detector separations across nineteen locations in the international 10-20 system~\cite{Strangman2013}. } 
    \label{fig:BScomparison}
\end{figure} 

\subsection{Slab-based brain sensitivity corresponds with atlas-based sensitivity}
Fig.~\ref{fig:BScomparison} shows $S_{brain}$ calculated using our five-layer slab model at \ac{SD} separations ranging from 1 to 60~mm in 1~mm increments (blue line). We also overlay full-head averages of $S_{brain}$ and standard deviations at 20, 25, 30, 35, and 40~mm separations from a previously published study~\cite{Strangman2013} using the Colin27 atlas.

Simulations on a five-layer slab model show an increase in $S_{brain}$ as \ac{SDS} increases. Additionally, $S_{brain}$ for \ac{SD} separations below 10~mm is less than 1.17\%. At 20, 25, 30, 35, and 40~mm separations, the maximum difference between the atlas-based and slab-based $S_{brain}$ values is less than 0.6\%. Fig.~\ref{fig:BScomparison} demonstrates that using a 2-D approximation of the \ac{ROI} and a layered brain structure provides a reasonable trade-off between accuracy and computational efficiency, especially for high-density probe characterization.

\subsection{Comparison between sample modules of various shapes.}
\label{subsec:comparison}
\ac{MOCA} allows the comparison of a wide range of \ac{fNIRS} module designs by quantifying the effects of probe-level design parameters on a probe's performance. As a showcase, here we report the results from a comparison of three equilateral module shapes (square, hexagon, and triangle) with the same optode layout tessellated over a 200$\times$200~mm \ac{ROI}, derived from the average surface area of the top half of an adult male head~\cite{McConville1980}. Square~\cite{Chitnis2016, Bci2017, Zimmermann2013} and hexagonal~\cite{Funane2017, Wyser2017, Zhao2019} \ac{fNIRS} modules have been extensively studied in literature and are chosen here for a quantitative comparison. While an equilateral triangle has not been reported in published module designs, we include it here because of the potential suitability for better tessellation of a 3-D surface in future extensions. With this comparison, we want to demonstrate both the scalability of \ac{MOCA} in analyzing full-head probes and how performance metrics change across module-level design decisions.

As mentioned above, \ac{MOCA} systematically tessellates the target \ac{ROI} using the module geometry and assigns each module an index number. If not considering within-module optode locations, only translation is needed for both square and hexagon modules to completely cover a region. For the triangle shape, \ac{MOCA} rotates every other triangle and its optodes 180 degrees to fill the \ac{ROI} without leaving any gaps. No other probe-level parameter changes are made for this comparison. Probe spacing is set to zero. The default SS threshold is set to 10~mm and the $SDS_{max}$ is set to 30~mm. The minimum distance between sources used in calculating SMGs is set to 2$\times SDS_{max}$. To avoid simultaneously changing multiple parameters and only focusing on module shape, an identical optode layout made of two sources and two detectors is used in all three module designs in this example. The edge length of the square is set to 33.33~mm, determined by the average length of three previously reported square-shaped module designs~\cite{Chitnis2016, Bci2017, Zimmermann2013}. The edge length of the hexagon and triangle is set to 20.68 and 50.65~mm, respectively, calculated to achieve the same area as the square module. The three-module designs as well as the tessellation of the hexagon-based probe over the \ac{ROI} are shown in Fig.~\ref{fig:fullmodules}. The derived performance metrics for each of the three sample probes are summarized in Table~\ref{tab:results}. The results that follow are only applicable to the specific module- and probe-level parameters chosen for this showcase.

\begin{figure}
\begin{center}
\subfigure[]{\label{fg:module1}\includegraphics[height=5cm]{fig/moca/Fig_4a.pdf}}
\subfigure[]{\label{fg:module2}\includegraphics[height=5cm]{fig/moca/Fig_4b.pdf}}
\subfigure[]{\label{fg:module3}\includegraphics[height=5cm]{fig/moca/Fig_4c.pdf}}
\subfigure[]{\label{fg:module4}\includegraphics[height=5cm]{fig/moca/Fig_4d.pdf}}
\end{center}
\caption {Elementary module designs used in a full-head comparison. (a), (b), and (c) show the perimeter of the square, hexagon, and triangle-based module designs, respectively. The optode layout of all three shapes is identical. Red circles represent sources while blue crosses represent detectors. (d) Tessellation of the hexagon module over an ROI. The dashed green line outlines the 200$\times$200~mm ROI.} \label{fig:fullmodules}

\end{figure} 

\begin{table}
    \centering
    \caption{Summary of quantitative performance metrics derived by MOCA when tessellating the three elementary module shapes over a 200$\times$200~mm region of interest.}
    \label{tab:results}
    \resizebox{\textwidth}{!}{%
    \begin{tabular}{@{}llccc@{}}
        \toprule
        Row &
          Performance Metric &
          \begin{tabular}[c]{@{}c@{}}Square-based \\ probe\end{tabular} &
          \begin{tabular}[c]{@{}c@{}}Hexagon-based\\ probe\end{tabular} &
          \begin{tabular}[c]{@{}c@{}}Triangle-based\\ probe\end{tabular} \\ \midrule
        1  & Total modules {[}N{]}                              & 36            & 42            & 40          \\
        2  & Total optodes {[}N{]}                              & 144           & 168           & 160         \\
        3  & Total channels {[}N{]}                             & 324           & 405           & 496         \\
        4  & Intra-module channels {[}N{]}                      & 180           & 237           & 336         \\
        5  & Inter-module channels {[}N{]}                      & 144           & 168           & 160         \\
        6  & \% of channels that are inter-module {[}\%{]}      & 55.56         & 58.52         & 67.74       \\
        7  & Average brain sensitivity {[}\%{]}                 & 7.52 $\pm$ 1.95 & 6.50 $\pm$ 2.44 & 8.83 $\pm$ 3.10 \\
        8  & Average intra-module brain sensitivity {[}\%{]}    & 6.44 $\pm$ 2.10 & 6.44 $\pm$ 2.10 & 6.44 $\pm$ 2.10 \\
        9  & Average inter-module brain sensitivity {[}\%{]}    & 8.82 $\pm$ 0.00 & 6.54 $\pm$ 2.66 & 9.94 $\pm$ 2.86 \\
        10 & Spatial multiplexing groups {[}N{]}                & 9             & 8             & 13          \\
        11 & Spatial Multiplexing Ratio                         & 8             & 10.5          & 6.15      \\ \bottomrule
    \end{tabular}%
    }
\end{table}

\subsubsection{Effect of module shape on channel separation distributions}
Fig.~\ref{fig:fullchannels} shows a histogram of the \ac{SD} separations of the full-head (200$\times$200~mm area) probe composed from the three selected module shapes. Table~\ref{tab:results} shows that the number of modules needed to cover the \ac{ROI} varies for each shape due to the complete coverage constraint enforced by \ac{MOCA} for this showcase (Fig.~\ref{fig:fullmodules}d). Since each module utilizes the same optode layout, the intra-module channel distributions (blue bars in Figs.~\ref{fig:fullchannels}a, \ref{fig:fullchannels}b, and \ref{fig:fullchannels}c) are simply scaled by the total numbers of modules needed to completely cover the \ac{ROI}. The \ac{SDS} of inter-module channels are dependent on the module shape, resulting in varying inter-module channel distributions between all three probes (orange bars in Figs.~\ref{fig:fullchannels}a, \ref{fig:fullchannels}b, and \ref{fig:fullchannels}c). 

\begin{figure}
\begin{center}
\subfigure[]{\label{fg:chann1}\includegraphics[height=6.2cm]{fig/moca/Fig_5a.pdf}}
\subfigure[]{\label{fg:chann2}\includegraphics[height=6.2cm]{fig/moca/Fig_5b.pdf}}
\subfigure[]{\label{fg:chann3}\includegraphics[height=6.2cm]{fig/moca/Fig_5c.pdf}}
\subfigure[]{\label{fg:chann4}\includegraphics[height=6.2cm]{fig/moca/Fig_5d.pdf}}
\end{center}
\caption {Channel distributions and total channel counts resulting from the tessellation of the three elementary module shapes over a 200$\times$200~mm region of interest. (a-c) Resulting intra- and inter-module channel distributions for square, hexagon, and triangle module-based probes. (d) The total channel count of each probe grouped by intra- and inter-module channels.} \label{fig:fullchannels}

\end{figure} 

For this particular example, the triangle-based probe reports both the highest number of total channels (Fig.~\ref{fig:fullchannels}d) and the largest \ac{SD} separations of all three tessellated probes (Fig.~\ref{fig:fullchannels}c). The hexagon-based probe appears to have the shortest inter-module channels (Fig.~\ref{fig:fullchannels}b). Due to its symmetry and given the $SDS_{max}$ setting, the square-based probe happens to have all \ac{SD} separations at 24~mm. Notably, the triangle-based probe adds the most inter-module channels, almost twice the number of intra-module channels (Fig.~\ref{fig:fullchannels}d), while also requiring two fewer modules than the hexagon-based probe (Table~\ref{tab:results}, Rows 1-5). Fig.~\ref{fig:fullchannels}d also shows that the number of inter-module channels is greater than the number of intra-module channels for all three probes.


\subsubsection{Combining intra- and inter-module channels for brain sensitivity}
The $\overline{S_{brain}}$ values derived from the three probe designs, grouped by intra-module channels, inter-module channels, and all channels, are summarized in Fig.~\ref{fig:fullbrainsensitivity}. Only channels above the SS threshold and below the $SDS_{max}$ are used. Despite having the fewest total channels (Table~\ref{tab:results}, Row 3), the square-based probe results in a higher $\overline{S_{brain}}$ than the hexagon-based probe. For the square- and triangle-based probes, the use of inter-module channels increases the probe's $\overline{S_{brain}}$ as compared to simply using intra-module channels alone. For the hexagon-based probe, $\overline{S_{brain}}$ computed using only intra-module channels is similar to that when using only inter-module channels (6.44\% vs 6.54\%). Due to having the same optode layout, the intra-module $\overline{S_{brain}}$ is the same for all three probes. 

\begin{figure}
    \begin{center}
    \begin{tabular}{c}
    \includegraphics[width=8cm]{fig/moca/Fig_6.pdf}
    \end{tabular}
    \end{center}
    \caption {Resulting average brain sensitivity organized by intra- and inter-module channels for square-, hexagon-, and triangle-based probes tessellated over a 200$\times$200~mm region. Short-separation channels are excluded from all calculations.} 
    \label{fig:fullbrainsensitivity}
\end{figure} 


\subsubsection{Effect of module shapes on improving sampling rate}
The total $n_s$ compared to the $n_{SMG}$ arising from the tessellation of each module over the \ac{ROI} are compared in Fig.~\ref{fig:fullgroups}a. The total number of sources for the square-, hexagon- and triangle-based probes are 72, 84, and 80, respectively. Fig.~\ref{fig:fullgroups}b overlays the first SMG over the triangle-based full-head probe. Using the $n_{SMG}$ for each probe (Table~\ref{tab:results}, Row 10), the SMR (the ratio between $n_s$ and $n_{SMG}$) is 8, 10.5, and 6.15 for the square-, hexagon-, and triangle-based probe, respectively. This result indicates that the hexagon-based probe's sampling rate can benefit the most when using  group-based spatial multiplexing.

\begin{figure}
\begin{center}
\subfigure[]{\label{fg:group1}\includegraphics[height=6cm]{fig/moca/Fig_7a.pdf}}
\subfigure[]{\label{fg:group2}\includegraphics[height=6cm]{fig/moca/Fig_7b.pdf}}
\end{center}
\caption {Spatial multiplexing group results from the tessellation of the square-, hexagon-, and triangle-based probes. (a) Comparison of the total number of sources (orange) and the total number of spatial multiplexing groups (green). (b) The triangle-based module tessellation with sources (red circles) and detectors (blue crosses). The dashed red circles indicate the ``effective'' region (30~mm radius) of each of the nine sources in the first spatial multiplexing group. The nine sources turned on simultaneously in this group are indicated by filled-in red circles.} \label{fig:fullgroups}
\end{figure} 


\subsection{Improving existing probes through probe-level parameter alterations}
The ability to compute performance metrics from basic design parameters allows users to explore probe-level alterations and potentially improve existing probes using \ac{MOCA}. Here, we simulate and alter published examples to demonstrate how even simple module layout changes such as rotating selected modules, altering probe spacing, and staggering modules can potentially improve published probe designs.

\subsubsection{Effect of optode orientation on probe characteristics}
Re-orienting modules within existing probes alters the \ac{SDS} distribution and, consequently, the probe's $S_{brain}$ and SMR. In Fig.~\ref{fig:orientation}, we simulate a 36~$\textrm{mm}^2$ square module in a probe configuration inspired by the $\mu$NTS \ac{fNIRS} module described in Chitnis~\emph{et al.}~\cite{Chitnis2016}. The modules in the initial tessellation are oriented in the same direction as in the original paper (Fig.~\ref{fig:orientation}a). In our investigation, the spacing between each module is set to 5~mm and the $SDS_{max}$ is set to 30~mm. Each module has 2 sources and 4 detectors, resulting in 8 intra-module channels per module ranging from 8 to 29~mm. A total of 256 different probe configurations result from exhaustively re-orienting each module individually by 90 degrees. Without losing generality, a subset of 128 layouts are shown in Fig.~\ref{fig:orientation}b to show the range of the variations.

\begin{figure}
\begin{center}
\subfigure[]{\label{fg:orien1}\includegraphics[height=4.5cm]{fig/moca/Fig_8a.pdf}}
\subfigure[]{\label{fg:orien2}\includegraphics[height=4.5cm]{fig/moca/Fig_8b.pdf}}
\subfigure[]{\label{fg:orien4}\includegraphics[height=4.5cm]{fig/moca/Fig_8c.pdf}}
\subfigure[]{\label{fg:orien5}\includegraphics[height=4.5cm]{fig/moca/Fig_8d.pdf}}
\subfigure[]{\label{fg:orien3}\includegraphics[height=4.5cm]{fig/moca/Fig_8e.pdf}}
\end{center}
\caption{A 4-module probe simulated using MOCA. (a) All modules are oriented in the same direction. Red circles represent sources and blue crosses represent detectors. An exhaustive search of all combinations of orientations for each of the four modules results in 256 possible layouts. The average brain sensitivity and number of spatial multiplexing groups for the first 128 layouts are shown in (b). The original layout (layout number 1) is highlighted in the red square. An example layout with the maximum possible brain sensitivity (layout number 66) is highlighted in the green square. (c) A visual representation of layout 66 with the bottom-left and top-right modules rotated 90 degrees clockwise with respect to orientation in (a). Intra- and inter-module channel distribution resulting from the original layout is shown in (d). Channel counts resulting from the probe configuration in (c) are shown in (e). In both channel distribution histograms (d, e), intra- and inter-module channels are shown in blue and orange, respectively. Dark orange indicates overlapping histogram counts.} 
\label{fig:orientation}
\end{figure} 

Of the 256 possible layout configurations, 8 of those layouts result in a maximum average brain sensitivity of 9.87\%. These 8 layouts also achieve the minimum number ($n_{SMG}=4$) of spatial multiplexing groups. The intra- and inter-module channel distribution and channel count resulting from the \ac{MOCA} analysis of the original probe layout are shown in Fig.~\ref{fig:orientation}d. Fig.~\ref{fig:orientation}c shows the same 4-module probe but constructed with the bottom-left and top-right modules rotated 90 degrees clockwise, corresponding to layout number 66 in Fig.~\ref{fig:orientation}b. Using \ac{MOCA}, the spatial channel plot overlaid onto this re-oriented probe shows a denser coverage of the center of the \ac{ROI} compared to the original probe layout. The channel count distribution of this re-oriented probe is shown in Fig.~\ref{fig:orientation}e. As expected, the intra-module channels in Fig.~\ref{fig:orientation}a and Fig.~\ref{fig:orientation}c are identical. However, re-orienting the two modules produces a shift towards longer separation inter-module channels that are known to be more sensitive to brain tissues. The number of inter-module channels within the 10 to 20~mm range decreases from 8 to 4 and the number of 29~mm separation inter-module channels increases from 2 to 12 upon re-orienting the 2 modules. The re-orientation of modules not only allows the probe to have more long-separation channels, it also increases the total number of inter-module channels from 14 to 20 (Fig.~\ref{fig:orientation}d and e). Additionally, $\overline{S_{brain}}$ of the probe increases from 8.56\% to 9.87\% (Fig.~\ref{fig:orientation}f) while the number of spatial multiplexing groups, and subsequently the probe's sampling rate, remains the same.


\subsubsection{Effect of probe spacing on probe performance}
Probe spacing\textemdash the distance between edges of adjacent modules in a probe\textemdash is a parameter that can vary the resulting channel distribution and channel density of a probe by altering the relative distances between optodes on neighboring modules. To investigate the effect of this parameter, in Fig.~\ref{fig:spacing}, we simulate the probe layout described by Zhao~\emph{et al.}~\cite{Zhao2019}, which utilizes hexagonal-shaped LUMO \ac{fNIRS} modules developed by Gowerlabs~\cite{Gowerlabs2019}. The length of each side of the hexagonal-shaped module used in our investigation is set to 18~mm and each module contains three sources and four detectors. The $SDS_{max}$ is set to 30~mm. A uniform spacing is set between all adjacent modules. Probe spacing is varied from 0 to 30~mm in 1~mm increments. 


\begin{figure}
\begin{center}
\subfigure[]{\label{fg:spacing1}\includegraphics[height=6cm]{fig/moca/Fig_9a.pdf}}
\subfigure[]{\label{fg:spacing2}\includegraphics[height=6cm]{fig/moca/Fig_9b.pdf}}
\end{center}
\caption {An analysis of hexagonal modules in a twelve-module probe. (a) Green arrows indicate the distances between modules as probe spacing varies. (b) The total channel count, average brain sensitivity, and the spatial multiplexing ratio at probe spacing values between 1 and 30~mm. Module orientations are held constant.} \label{fig:spacing}
\end{figure} 

When all modules are densely packed with a spacing of 1~mm, the probe results in 328 total channels (184 of which are inter-module channels), an $\overline{S_{brain}}$ of 5.95\%, and 12 SMGs. When the probe spacing is increased to 6~mm, the number of channels and spatial multiplexing groups remain the same while the $\overline{S_{brain}}$ increases (Fig.~\ref{fig:spacing}b). The increase in $\overline{S_{brain}}$ arises due to the overall increased distances between sources and detectors of inter-module channels which sample deeper into the brain tissue. This results in a local maximum $\overline{S_{brain}}$ of 7.87\%. 

When we increase probe spacing to 8~mm, the inter-module channel separations increase to above the $SDS_{max}$. This decreases the number of ``usable'' inter-module channels and the probe's $\overline{S_{brain}}$. The SMR remains unchanged between 6 and 8~mm probe spacing. Above 11~mm, the increase in probe spacing increases the relative distance between adjacent sources, allowing more sources to be turned on at the same time and decreasing the $n_{SMG}$ needed. This trend continues as we increase probe spacing. Consequently, the probe's $\overline{S_{brain}}$ reaches a minimal plateau of 3\% at 15~mm spacing and beyond because only intra-module channels above the SS threshold remain within the \ac{SD} range (Fig.~\ref{fig:spacing}b). Similarly, since modules are further apart, the $n_{SMG}$ continues to drop which increases the SMR (and the sampling rate of the probe when spatial multiplexing encoding is utilized). At 29mm spacing, the SMR value is 12 due to only 3 spatial multiplexing groups needed (one for each of the 3 sources on each module).

\subsubsection{Effect of staggering modules on probe characteristics}
Staggering adjacent modules within a high-density probe can increase inter-module \ac{SD} separations to improve performance. To demonstrate the effect of staggering on the resulting probe, in Fig.~\ref{fig:stagger} we simulate a 42~$\textrm{mm}^2$ square module in a 3$\times$1 layout configuration inspired by M3BA modules~\cite{Bci2017}. Each of our simulated modules contains two sources and two detectors. The probe was staggered by translating the center module between 0~mm and 42~mm along the horizontal axis.

\begin{figure}
\begin{center}
\subfigure[]{\label{fg:stag1}\includegraphics[height=5cm]{fig/moca/Fig_10a.pdf}}
\subfigure[]{\label{fg:stag2}\includegraphics[height=5cm]{fig/moca/Fig_10b.pdf}}
\subfigure[]{\label{fg:stag4}\includegraphics[height=5cm]{fig/moca/Fig_10c.pdf}}
\subfigure[]{\label{fg:stag5}\includegraphics[height=5cm]{fig/moca/Fig_10d.pdf}}
\subfigure[]{\label{fg:stag3}\includegraphics[height=5cm]{fig/moca/Fig_10e.pdf}}
\subfigure[]{\label{fg:stag6}\includegraphics[height=5cm]{fig/moca/Fig_10f.pdf}}
\end{center}
\caption {An analysis of square modules in a three-module probe. (a) A traditional three-module tessellation. Red circles represent sources and blue crosses represent detectors. (b) The resulting intra- and inter-module channel distribution from the probe layout in (a). (c) The average brain sensitivity for each layout resulting from module staggering separated by intra- and inter-module channel contributions. (d) The center module staggered by 26~mm, resulting in increased channel separation for inter-module channels, as shown in (e). (f) The total channel count and the number of spatial multiplexing groups of the probe layout as the center module is staggered between 0 and 42~mm.}
 \label{fig:stagger}
\end{figure} 

In Fig.~\ref{fig:stagger}a, we overlaid the intra- (blue) and inter-module (orange) channels over the three-module probe. The resulting channel distribution shows 12 intra-module channels at 28~mm and 4 inter-module channels at 14~mm \ac{SD} separations (Fig.~\ref{fig:stagger}b). The $\overline{S_{brain}}$ of this probe using all channels is 8.79\% (Fig.~\ref{fig:stagger}c). When analyzed separately by intra- and inter-module channels, the $\overline{S_{brain}}$ using only intra-module channels (10.75\%) is larger the $\overline{S_{brain}}$ when using only inter-module channels (2.9\%) since in this tessellation intra-module channels are larger and probe deeper into the tissue.  

In Fig.~\ref{fig:stagger}c, we show the effect of staggering the tessellated module layout by translating the center module along the horizontal axis. This alteration increases the inter-module channel separations. Consequently, the $\overline{S_{brain}}$ due to only inter-module channels increases until the inter-module channel separations are larger than the $SDS_{max}$. The $\overline{S_{brain}}$ using all channels increases from 8.79\% in the original tessellation to a maximum of 10.95\% in the staggered tessellation at 26~mm. The $n_{SMG}$ between the two layouts remained the same until a staggering amount of 31~mm at which point the sources are far away enough to group them together (Fig.~\ref{fig:stagger}f). 



%%%% SECTION %%%%
% DISCUSSION
\section{Discussion}
\label{sec:discussion}
Through the case studies shown in the above section, we demonstrate the high complexity in designing a modular probe, where even adjusting a single parameter may have a profound impact to other parameters as well as the overall performance. Despite the fact that \ac{MOCA} only permits operator-guided parameter interrogation in a well-constrained problem, the results from the above experiments did reveal a number of important design strategies that were not previously discussed in literature, including the effect of module re-orientation, fine-tuning the space between modules, and module staggering to potentially improve existing \ac{fNIRS} probes.

%%% Full probe comparison
%% channel distribution
Fig.~\ref{fig:fullchannels} reveals that, despite having the same optode layout, probes composed of different module shapes covering the same \ac{ROI} result in different channel distributions. Although the inter-module channels are identical between modules, the resulting total number of channels is related to the number of modules needed to cover the \ac{ROI}. The effect of module shape on channel distribution is complex and requires a tool like \ac{MOCA} to thoroughly investigate. Certain module geometries result in optodes closer to the module's edges, effectively shortening inter-module channels in completely tessellated probes. Because the optode layout in Fig.~\ref{fig:fullmodules} is not completely symmetric and each module shape is an equilateral polygon, each individual module can be re-oriented without overlapping while maintaining the complete tessellation of the probe. While not altering intra-module channel distributions, these orientation configurations spatially alter channel locations and alter inter-module channel separations. The results from Fig.~\ref{fig:fullchannels} also show how some individual module shapes may be more appropriate for certain subject populations. For example, the high count of 19~mm inter-module channel separations in the hexagon-based probe makes it better suited for infant populations. An important takeaway is that the number of inter-module channels of an assembled probe is not a simple multiplicative factor of the number of intra-module channels. These results demonstrate the dependency a probe's derived characteristics have on module shape even when different modules have the exact same optode layout. 

%% brain sensitivity
The results in Fig.~\ref{fig:fullbrainsensitivity} provide a counter-example where higher channel density due to increased inter-module channels may not necessarily improve all performance metrics of a probe. Despite having fewer total channels than the hexagon-based probe, the square-based probe results in a higher average brain sensitivity ($\overline{S_{brain}}$) due to larger inter-module channel separations. This reveals the trade-offs in performance metric improvement, emphasizing the need for $S_{brain}$ to be considered in conjunction with channel distribution when comparing probes. Additionally, this analysis reveals that the use of inter-module channels in addition to intra-module channels does not always lead to increased $S_{brain}$ for probes based on different module shapes. In fact, the use of only inter-module channels increases the average penetration depth for the square- and triangle-based probes due to the larger channel separations. However, for the hexagon-based probe design in this example, Fig.~\ref{fig:fullbrainsensitivity} demonstrates that the contribution to $\overline{S_{brain}}$ from using only intra- or only inter-module channels differed by merely 0.1\%. These results show that adding inter-module channels to intra-module probes will not always result in improved $\overline{S_{brain}}$. Thus, users of this particular hexagon-based probe may benefit from the simplicity and faster sampling rate of using only intra-module channels rather than implementing a potentially complex data acquisition method to capture inter-module channels. Although ignoring inter-module channels can increase the sampling rate without affecting $S_{brain}$ for this particular probe, it does result in fewer channels and lowers the channel density of the probe. Through this complex example, we show that it is non-trivial to consider all constraints in a modular probe. \ac{MOCA} is positioned as a tool to help designers challenge hypotheses, explore alternative designs, and quantify various trade-offs.

%% Spacial Multiplexing 
Fig.~\ref{fig:fullgroups} indicates that the hexagon-based probe can achieve the highest sampling rate among the three configurations if a spatial multiplexing encoding strategy is implemented. The frame rate of a sequential encoding strategy is dependent on the total number of sources ($n_s$) because each source needs to be turned on and sampled once. Spatial multiplexing allows multiple sources within a group to be turned on simultaneously, allowing the sampling rate to increase by a factor of $n_s/n_{SMG}$, defined as the spatial multiplexing ratio (SMR). Therefore, despite having the lowest sampling rate when sampled sequentially due to the highest $n_s$ (Table~\ref{tab:results}, Row 1), the hexagon-based probe has the fastest sampling rate of the three probes when spatial multiplexing is used due to the low $n_{SMG}$ (Fig.~\ref{fig:fullgroups}a). These results demonstrate that a probe's sampling rate can be increased not only through firmware changes or advanced electronics but also by using different module shapes with the same optode layout.

%%% Improving existing probes
%% orientation
While \ac{MOCA}'s ability to change module-level parameters helps design new \ac{fNIRS} modules, its ability to sweep through probe-level parameters helps potentially improve existing ones. Fig.~\ref{fig:orientation} shows how probes based on published modules can potentially improve $\overline{S_{brain}}$ at no increased cost and without re-designing modules by altering the orientations of modules that make up the probe. The orientation changes in layout 66 (Fig.~\ref{fig:orientation}c) increase the channel density at the center of the \ac{ROI}, but also increase the number of inter-module channels by 43\%. The emerging inter-module channels also have larger \ac{SDS) and contribute to an increase in $\overline{S_{brain}}$ without changing the SMR. The re-oriented probe in Fig.~\ref{fig:orientation}c is only a representative case of how a 2$\times$2 probe composed of square modules can be potentially improved and is exhaustive only because the number of possible orientations of each of the 4 modules was limited to 4, resulting in $4^4=256$ probe layouts to analyze. Additionally, the re-orientation of modules causes changes to performance metrics due to the asymmetry of the optode layout within each module. If the optode layout was symmetric, re-orienting modules would have no effect on either inter- or intra-module channels. 

%% spacing
In Fig.~\ref{fig:spacing}, we investigated the effect of spacing between modules on the derived performance metrics of a probe composed of hexagonal-shaped modules. The results suggest that varying module spacing does have an impact on $\overline{S_{brain}}$. Since optodes are generally placed near the edges of the modules to maximize intra-module channel separations, dense probes with modules near one another tend to have shorter inter-module channel separations. This trend becomes more apparent as the size of the module increases. Increasing the probe spacing increases the distance between optodes on neighboring modules, thus increasing the $\overline{S_{brain}}$ in the process. This increase in $\overline{S_{brain}}$, however, has a local maximum. As shown in Fig.~\ref{fig:spacing}, further increasing probe spacing leads to a drop in the number of inter-module channels as their \ac{SD} separations become greater than the separation limit ($SDS_{max}$). Additionally, increasing the distance between modules reduces the number of multiplexing groups ($n_{SMG}$) which increases the SMR and consequently the probe's sampling rate. Once the probe spacing exceeds the user-specified SMG diameter, one source on each module can be turned on at the same time because each source would be outside the other's ``effective'' region. Because the distance between sources on the same module does not change, a different SMG is required for each source within a module. Thus, the limit to the minimum $n_{SMG}$ is equal to the number of sources on a single module, revealing a minimum improvement in sampling rate due to spatial multiplexing encoding. Compared to a sequential sampling strategy, a spatial multiplexing encoding strategy will increase a probe's sampling rate by at least a factor equal to the number of sources on one module. Fig.~\ref{fig:spacing} shows that probe spacing can both alter $n_{SMG}$ to help meet sampling rate requirements and alter inter-module channel separations to meet channel distribution needs.

%% staggering
Fig.~\ref{fig:stagger} shows that staggering a probe layout can increase $\overline{S_{brain}}$ in dense probes. Simulations using a published module shape~\cite{Bci2017} with zero probe spacing results in inter-module channels of 14~mm separations. These channels are too long to be short-separation (SS) channels and too short to be long-separation (LS) channels. Staggering spatially increases inter-module channel separations while maintaining the compactness of a probe (Fig.~\ref{fig:stagger}c). This improvement works with square or rectangular modules since staggering is done by translating user-specified modules along a horizontal or vertical axis. For module designs with symmetrical optode layouts, we recommend staggering probe layouts by translating every other module row by half of the module's maximum width in one axis (Fig.~\ref{fig:stagger}f). This ensures the optodes from the translated module are well separated from modules of the adjacent rows.

%%% MOCA limitations
The results above are derived from investigating the module- and probe-level design parameters that \ac{MOCA} currently supports. However, this only represents a small subset of the general parameters previously used in evaluating a modular probe~\cite{Zhao2017}. For example, user feedback-based design parameters not yet accounted for in \ac{MOCA} include conformability (a module's ability to conform to a curved surface), subject comfort, and safety limits such as operating voltage and heating effects. Source output power and module weight each require external instrumentation measurements while noise-equivalent power and dynamic range calculations require lab-specific phantoms. Power consumption depends on the type of optodes used as well as the control electronics of the individual module while a probe's battery life can be adjusted using existing off-the-shelf components. Each of these design parameters are based on specific electronic or material components chosen for a particular module design. \ac{MOCA} was built to easily scale and incorporate more complex mechanical-, ergonomic-, safety- and experiment-specific considerations in the future as those design parameters are evaluated.

There are limitations to \ac{MOCA}'s current minimal subset of design parameters. First, the ability to re-orient, increase spacing, or stagger modules assumes that modules can be connected in any orientation. This is true for many published modular designs where cables of different lengths can be easily connected to the top of a module, but does not necessarily apply to more sophisticated designs that have embedded printed flex connectors or utilize headgears with pre-determined mounting locations. Second, \ac{MOCA} does not currently support multiple module shapes within the same probe or different optode layouts on different modules. Third, \ac{MOCA}'s channel count output does not include wavelength count as a multiplier. This approach allows one to quickly scale the channel distribution and channel counts when dual-wavelength or triple-wavelength sources are utilized. Similarly, the $n_{SMG}$ is also defined for a single wavelength. Thus, when estimating the total sampling rate of the probe using multi-wavelength sources, the control unit must cycle through each group multiple times (once for each wavelength). Fourth, \ac{MOCA}'s analysis is based on the coordinates of the center of an optode's active area and does not account for the actual size of the optode package, the shape of the optode's active area, or any master control unit needed to control a series of modules. Despite being able to place optodes near the edge of modules in \ac{MOCA}, designers may face constraints in practice imposed by the fabrication process due to board materials, sizes, and electrical routing needed to drive these optoelectronics. In general, module shapes with large interior angles allow optodes to be placed closer to the module's perimeter. Fifth, \ac{MOCA}'s probe-level functions are but one method of interrogating parameters in a systematic way. These functions vary parameters in discrete increments (fixed number of orientations, a set spacing range, and user-defined translation amounts) and therefore only explore a subset of all potential probe layouts. They do not determine an optimal probe configuration\textemdash they assist in improving existing probes by adding design constraints (holding module-level parameters constant) and allowing a user to identify design choices that improve performance for their particular application.  Finally, \ac{MOCA} can output 2-D optode layouts but relies on other existing software, such as AtlasViewer~\cite{Aasted2015}, to perform 3-D head contour registration. It does, however, automatically add spring relationships to embed modular aspects into an exported probe. For example, the distance between all optodes (both sources and detectors) within a module is fixed, while inter-module channels can vary slightly. This ensures that a physically rigid electronic module does not transform when registered to a surface. In addition, the performance metrics output by \ac{MOCA} are currently based on a 2-D probe layout and do not account for changes in \ac{SDS} if the probe is ``wrapped'' on the 3-D surface of a head~\cite{Zhao2021}. Consequently, 2-D-derived metrics may underestimate the number of channels when a probe is made to conform to the scalp. This may result in an increase in the number of total inter-module channels for a probe. However, by working in 2-D, \ac{MOCA} can both help unearth design and performance relationships, as well as drastically constrain the vast potential design space by helping researchers converge on the module- and probe-level parameters that most impact performance.